import{a as Q,u as V,r as n,j as e,s as o}from"./index-CQCmJ27i.js";function Y(){const{profile:m,loading:p}=Q(),N=V(),[S,k]=n.useState([]),[v,C]=n.useState([]),[D,$]=n.useState([]),[L,w]=n.useState(!0),[q,d]=n.useState(!1),[u,x]=n.useState(null),[g,I]=n.useState("all"),[h,E]=n.useState("all"),[f,T]=n.useState("all"),[r,l]=n.useState({user_id:"",title:"",content:"",record_type:"plan",record_date:new Date().toISOString().split("T")[0]});if(n.useEffect(()=>{if(!p){if(m?.role!=="admin"){N("/user/dashboard");return}R(),U(),b()}},[m,p]),p)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"読み込み中..."})]})});const R=async()=>{const{data:t,error:s}=await o.from("profiles").select("id, username, furigana").eq("role","user").order("furigana");if(s){console.error("利用者データ取得エラー:",s);return}t&&C(t)},U=async()=>{const{data:t,error:s}=await o.from("profiles").select("id, username, furigana").eq("role","admin").order("furigana");if(s){console.error("指導員データ取得エラー:",s);return}t&&$(t)},b=async()=>{w(!0);const{data:t,error:s}=await o.from("support_records").select(`
        *,
        profiles:user_id (
          username,
          furigana
        ),
        creator:created_by (
          username,
          furigana
        )
      `).order("record_date",{ascending:!1});s?console.error("データ取得エラー:",s):t&&k(t),w(!1)},A=async t=>{if(t.preventDefault(),u){const{error:s}=await o.from("support_records").update({user_id:r.user_id,title:r.title,content:r.content,record_type:r.record_type,record_date:r.record_date}).eq("id",u);if(s){console.error("更新エラー:",s),alert("更新に失敗しました");return}}else{const{error:s}=await o.from("support_records").insert({user_id:r.user_id,title:r.title,content:r.content,record_type:r.record_type,record_date:r.record_date,created_by:m?.id});if(s){console.error("作成エラー:",s),alert("作成に失敗しました");return}}d(!1),x(null),j(),b()},J=t=>{x(t.id),l({user_id:t.user_id,title:t.title,content:t.content,record_type:t.record_type,record_date:t.record_date}),d(!0)},O=async t=>{if(!confirm("本当に削除しますか？"))return;const{error:s}=await o.from("support_records").delete().eq("id",t);if(s){console.error("削除エラー:",s),alert("削除に失敗しました");return}b()},P=t=>{const s=_(t.record_type),F=new Date(t.record_date).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),M=new Date(t.created_at).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});let a="";a+=`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`,a+=`　　　　　　　${s}報告書
`,a+=`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

`,a+=`【基本情報】
`,a+=`　記録種別：${s}
`,a+=`　記録日：${F}
`,a+=`　利用者名：${t.profiles?.username}（${t.profiles?.furigana}）
`,a+=`　指導員：${t.creator?.username}（${t.creator?.furigana}）
`,a+=`　作成日時：${M}

`,a+=`【タイトル】
`,a+=`　${t.title}

`,a+=`【内容】
`,t.content.split(`
`).forEach(K=>{a+=`　${K}
`}),a+=`
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`,a+=`　発行日：${new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})}
`,a+=`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;const B=new Blob([a],{type:"text/plain;charset=utf-8;"}),i=document.createElement("a"),G=URL.createObjectURL(B),H=`${s}_${t.profiles?.username}_${new Date(t.record_date).toISOString().split("T")[0]}.txt`;i.setAttribute("href",G),i.setAttribute("download",H),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)},j=()=>{l({user_id:"",title:"",content:"",record_type:"plan",record_date:new Date().toISOString().split("T")[0]})},c=S.filter(t=>!(g!=="all"&&t.user_id!==g||h!=="all"&&t.record_type!==h||f!=="all"&&t.created_by!==f)),y={total:c.length,plan:c.filter(t=>t.record_type==="plan").length,caseNote:c.filter(t=>t.record_type==="case_note").length},_=t=>t==="plan"?"個別支援計画":"ケース記録",z=t=>t==="plan"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700";return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>N("/admin/dashboard"),className:"w-10 h-10 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-arrow-left-line text-xl"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"支援記録管理"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"個別支援計画・ケース記録"})]})]}),e.jsxs("button",{onClick:()=>{j(),x(null),d(!0)},className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-add-line mr-2"}),"新規作成"]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6 flex flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"利用者"}),e.jsxs("select",{value:g,onChange:t=>I(t.target.value),className:"px-4 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer",children:[e.jsx("option",{value:"all",children:"すべての利用者"}),v.map(t=>e.jsxs("option",{value:t.id,children:[t.username,"（",t.furigana,"）"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"記録種別"}),e.jsxs("select",{value:h,onChange:t=>E(t.target.value),className:"px-4 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer",children:[e.jsx("option",{value:"all",children:"すべての種別"}),e.jsx("option",{value:"plan",children:"個別支援計画"}),e.jsx("option",{value:"case_note",children:"ケース記録"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"指導員"}),e.jsxs("select",{value:f,onChange:t=>T(t.target.value),className:"px-4 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer",children:[e.jsx("option",{value:"all",children:"すべての指導員"}),D.map(t=>e.jsxs("option",{value:t.id,children:[t.username,"（",t.furigana,"）"]},t.id))]})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 text-white",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white/20 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"総記録数"}),e.jsx("p",{className:"text-3xl font-bold",children:y.total})]}),e.jsxs("div",{className:"bg-white/20 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"個別支援計画"}),e.jsx("p",{className:"text-3xl font-bold",children:y.plan})]}),e.jsxs("div",{className:"bg-white/20 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"ケース記録"}),e.jsx("p",{className:"text-3xl font-bold",children:y.caseNote})]})]})})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100",children:L?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"読み込み中..."}):c.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"記録がありません"}):e.jsx("div",{className:"divide-y divide-gray-100",children:c.map(t=>e.jsx("div",{className:"p-6 hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${z(t.record_type)}`,children:_(t.record_type)}),e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:t.title})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("span",{children:[e.jsx("i",{className:"ri-user-line mr-1"}),t.profiles?.username,"（",t.profiles?.furigana,"）"]}),e.jsxs("span",{children:[e.jsx("i",{className:"ri-shield-user-line mr-1"}),"指導員: ",t.creator?.username,"（",t.creator?.furigana,"）"]}),e.jsxs("span",{children:[e.jsx("i",{className:"ri-calendar-line mr-1"}),"記録日: ",new Date(t.record_date).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"})]})]}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:t.content})]}),e.jsxs("div",{className:"flex gap-2 ml-4",children:[e.jsx("button",{onClick:()=>P(t),className:"w-10 h-10 flex items-center justify-center text-green-600 hover:bg-green-50 rounded-lg transition-colors cursor-pointer",title:"報告書をエクスポート",children:e.jsx("i",{className:"ri-file-download-line text-lg"})}),e.jsx("button",{onClick:()=>J(t),className:"w-10 h-10 flex items-center justify-center text-blue-600 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-edit-line text-lg"})}),e.jsx("button",{onClick:()=>O(t.id),className:"w-10 h-10 flex items-center justify-center text-red-600 hover:bg-red-50 rounded-lg transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-delete-bin-line text-lg"})})]})]})},t.id))})})]}),q&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-100",children:e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:u?"記録を編集":"新規記録作成"})}),e.jsxs("form",{onSubmit:A,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["利用者 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:r.user_id,onChange:t=>l({...r,user_id:t.target.value}),className:"w-full px-4 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"",children:"選択してください"}),v.map(t=>e.jsxs("option",{value:t.id,children:[t.username,"（",t.furigana,"）"]},t.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["記録種別 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:r.record_type,onChange:t=>l({...r,record_type:t.target.value}),className:"w-full px-4 py-2 pr-8 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer",required:!0,children:[e.jsx("option",{value:"plan",children:"個別支援計画"}),e.jsx("option",{value:"case_note",children:"ケース記録"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["記録日 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:r.record_date,onChange:t=>l({...r,record_date:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["タイトル ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:r.title,onChange:t=>l({...r,title:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"記録のタイトルを入力",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["内容 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:r.content,onChange:t=>l({...r,content:t.target.value}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:8,placeholder:"記録の内容を入力",required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{d(!1),x(null),j()},className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium whitespace-nowrap cursor-pointer",children:"キャンセル"}),e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium whitespace-nowrap cursor-pointer",children:u?"更新":"作成"})]})]})]})})]})}export{Y as default};
//# sourceMappingURL=page-Bxy5_tWM.js.map
