import{a as J,u as Z,r as f,j as e,s as v}from"./index-CQCmJ27i.js";const M=(k=new Date)=>{const j=new Date(k.toLocaleString("en-US",{timeZone:"Asia/Tokyo"})),$=j.getFullYear(),h=String(j.getMonth()+1).padStart(2,"0"),S=String(j.getDate()).padStart(2,"0");return`${$}-${h}-${S}`};function G(){const{profile:k,loading:j}=J(),$=Z(),[h,S]=f.useState("attendance"),[c,C]=f.useState(new Date),[o,L]=f.useState([]),[i,Y]=f.useState([]),[P,A]=f.useState([]),[I,T]=f.useState(!0);if(f.useEffect(()=>{if(!j){if(k?.role!=="admin"){$("/user/dashboard");return}h==="attendance"?U():q()}},[k,j,c,h]),j)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"読み込み中..."})]})});const U=async()=>{T(!0);const t=new Date(c.getFullYear(),c.getMonth(),1),a=new Date(c.getFullYear(),c.getMonth()+1,0),y=M(t),m=M(a),u=a.getDate(),{data:d}=await v.from("profiles").select("id, username, furigana").eq("role","user").order("furigana"),{data:s}=await v.from("attendance").select("*").gte("date",y).lte("date",m);if(d&&s){const r=d.map(b=>{const p=s.filter(n=>n.user_id===b.id),R=p.filter(n=>n.status==="normal").length,x=p.filter(n=>n.status==="early_leave").length,l=p.filter(n=>n.status==="late_normal").length,g=p.filter(n=>n.status==="late_early").length,w=p.filter(n=>n.status==="absent").length,_=u-p.length,F=u>0?Math.round((R+x+l+g)/u*100):0;return{userId:b.id,username:b.username,furigana:b.furigana,normal:R,earlyLeave:x,lateNormal:l,lateEarly:g,absent:w,notRecorded:_,totalDays:u,attendanceRate:F}});L(r)}T(!1)},q=async()=>{T(!0);const t=new Date(c.getFullYear(),c.getMonth(),1),a=new Date(c.getFullYear(),c.getMonth()+1,0),y=M(t),m=M(a),{data:u}=await v.from("profiles").select("id, username, furigana").eq("role","user").order("furigana"),{data:d}=await v.from("work_tasks").select("*"),{data:s}=await v.from("work_progress").select("*").gte("date",y).lte("date",m);if(u&&d&&s){const r=u.map(x=>{const l=s.filter(n=>n.user_id===x.id),g=[...new Set(l.map(n=>n.task_id))],w=g.filter(n=>l.filter(N=>N.task_id===n).some(N=>N.progress_rate===100)).length,_=g.filter(n=>{const D=l.filter(E=>E.task_id===n),N=Math.max(...D.map(E=>E.progress_rate));return N>0&&N<100}).length,F=l.length>0?Math.round(l.reduce((n,D)=>n+D.progress_rate,0)/l.length):0;return{userId:x.id,username:x.username,furigana:x.furigana,totalTasks:g.length,completedTasks:w,inProgressTasks:_,avgProgress:F,totalRecords:l.length}});Y(r);const b={light_work:{count:0,totalProgress:0,records:0},craft:{count:0,totalProgress:0,records:0},pc:{count:0,totalProgress:0,records:0},it:{count:0,totalProgress:0,records:0},external:{count:0,totalProgress:0,records:0}};d.forEach(x=>{const l=s.filter(g=>g.task_id===x.id);l.length>0&&(b[x.category].count++,b[x.category].totalProgress+=l.reduce((g,w)=>g+w.progress_rate,0),b[x.category].records+=l.length)});const p={light_work:"軽作業",craft:"クラフト",pc:"PC",it:"IT",external:"外部"},R=Object.entries(b).filter(([x,l])=>l.count>0).map(([x,l])=>({category:x,label:p[x],count:l.count,avgProgress:l.records>0?Math.round(l.totalProgress/l.records):0}));A(R)}T(!1)},O=()=>{C(new Date(c.getFullYear(),c.getMonth()-1))},V=()=>{C(new Date(c.getFullYear(),c.getMonth()+1))},W=()=>{let t="";const a=`${c.getFullYear()}年${c.getMonth()+1}月`;if(h==="attendance"){t="\uFEFF",t+=`勤怠統計レポート,${a}

`,t+=`利用者名,ふりがな,出勤→通常,出勤→早退,遅刻→通常,遅刻→早退,欠勤,未記入,総日数,出勤率(%)
`,o.forEach(s=>{t+=`${s.username},${s.furigana},${s.normal},${s.earlyLeave},${s.lateNormal},${s.lateEarly},${s.absent},${s.notRecorded},${s.totalDays},${s.attendanceRate}
`});const d={normal:o.reduce((s,r)=>s+r.normal,0),earlyLeave:o.reduce((s,r)=>s+r.earlyLeave,0),lateNormal:o.reduce((s,r)=>s+r.lateNormal,0),lateEarly:o.reduce((s,r)=>s+r.lateEarly,0),absent:o.reduce((s,r)=>s+r.absent,0),notRecorded:o.reduce((s,r)=>s+r.notRecorded,0),avgRate:o.length>0?Math.round(o.reduce((s,r)=>s+r.attendanceRate,0)/o.length):0};t+=`
合計,-,${d.normal},${d.earlyLeave},${d.lateNormal},${d.lateEarly},${d.absent},${d.notRecorded},-,${d.avgRate}
`}else{t="\uFEFF",t+=`作業実績レポート,${a}

`,t+=`利用者名,ふりがな,総作業数,完了作業,進行中作業,平均進捗率(%),進捗記録数
`,i.forEach(s=>{t+=`${s.username},${s.furigana},${s.totalTasks},${s.completedTasks},${s.inProgressTasks},${s.avgProgress},${s.totalRecords}
`});const d={totalTasks:i.reduce((s,r)=>s+r.totalTasks,0),completedTasks:i.reduce((s,r)=>s+r.completedTasks,0),inProgressTasks:i.reduce((s,r)=>s+r.inProgressTasks,0),avgProgress:i.length>0?Math.round(i.reduce((s,r)=>s+r.avgProgress,0)/i.length):0,totalRecords:i.reduce((s,r)=>s+r.totalRecords,0)};t+=`
合計,-,${d.totalTasks},${d.completedTasks},${d.inProgressTasks},${d.avgProgress},${d.totalRecords}
`,P.length>0&&(t+=`

カテゴリ別統計
`,t+=`カテゴリ,作業数,平均進捗率(%)
`,P.forEach(s=>{t+=`${s.label},${s.count},${s.avgProgress}
`}))}const y=new Blob([t],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a"),u=URL.createObjectURL(y);m.setAttribute("href",u),m.setAttribute("download",`${h==="attendance"?"勤怠統計":"作業実績"}_${c.getFullYear()}${String(c.getMonth()+1).padStart(2,"0")}.csv`),m.style.visibility="hidden",document.body.appendChild(m),m.click(),document.body.removeChild(m)},B=t=>({light_work:"bg-blue-500",craft:"bg-green-500",pc:"bg-purple-500",it:"bg-orange-500",external:"bg-pink-500"})[t]||"bg-gray-500";return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>$("/admin/dashboard"),className:"w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-arrow-left-line text-xl text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"統計・レポート"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"月次の勤怠統計と作業実績レポート"})]})]}),e.jsxs("button",{onClick:W,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"CSVエクスポート"]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-white rounded-lg p-1 shadow-sm border border-gray-200",children:[e.jsxs("button",{onClick:()=>S("attendance"),className:`px-4 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer whitespace-nowrap ${h==="attendance"?"bg-blue-500 text-white":"text-gray-600 hover:bg-gray-100"}`,children:[e.jsx("i",{className:"ri-calendar-check-line mr-2"}),"勤怠統計"]}),e.jsxs("button",{onClick:()=>S("work"),className:`px-4 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer whitespace-nowrap ${h==="work"?"bg-blue-500 text-white":"text-gray-600 hover:bg-gray-100"}`,children:[e.jsx("i",{className:"ri-task-line mr-2"}),"作業実績"]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-white rounded-lg px-4 py-2 shadow-sm border border-gray-200",children:[e.jsx("button",{onClick:O,className:"w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-arrow-left-s-line text-xl text-gray-600"})}),e.jsxs("span",{className:"text-sm font-medium text-gray-900 min-w-[120px] text-center",children:[c.getFullYear(),"年",c.getMonth()+1,"月"]}),e.jsx("button",{onClick:V,className:"w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-arrow-right-s-line text-xl text-gray-600"})})]})]}),I?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"データを読み込み中..."})]}):h==="attendance"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-check-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"出勤→通常 合計"}),e.jsxs("p",{className:"text-3xl font-bold",children:[o.reduce((t,a)=>t+a.normal,0),"日"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-time-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"早退・遅刻 合計"}),e.jsxs("p",{className:"text-3xl font-bold",children:[o.reduce((t,a)=>t+a.earlyLeave+a.lateNormal+a.lateEarly,0),"日"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-close-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"欠勤 合計"}),e.jsxs("p",{className:"text-3xl font-bold",children:[o.reduce((t,a)=>t+a.absent,0),"日"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-percent-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"平均出勤率"}),e.jsxs("p",{className:"text-3xl font-bold",children:[o.length>0?Math.round(o.reduce((t,a)=>t+a.attendanceRate,0)/o.length):0,"%"]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto",children:[e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"利用者別勤怠統計"})}),o.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx("i",{className:"ri-inbox-line text-4xl mb-2"}),e.jsx("p",{children:"データがありません"})]}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 bg-gray-50",children:[e.jsx("th",{className:"p-4 text-left text-sm font-bold text-gray-900",children:"利用者名"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"出勤→通常"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"出勤→早退"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"遅刻→通常"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"遅刻→早退"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"欠勤"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"未記入"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"出勤率"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:o.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.username}),e.jsx("p",{className:"text-sm text-gray-500",children:t.furigana})]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium",children:[t.normal,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium",children:[t.earlyLeave,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium",children:[t.lateNormal,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium",children:[t.lateEarly,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium",children:[t.absent,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium",children:[t.notRecorded,"日"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-24 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full",style:{width:`${t.attendanceRate}%`}})}),e.jsxs("span",{className:"text-sm font-bold text-gray-900 min-w-[45px]",children:[t.attendanceRate,"%"]})]})})]},t.userId))})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-task-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"総作業数"}),e.jsxs("p",{className:"text-3xl font-bold",children:[i.reduce((t,a)=>t+a.totalTasks,0),"件"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-check-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"完了作業"}),e.jsxs("p",{className:"text-3xl font-bold",children:[i.reduce((t,a)=>t+a.completedTasks,0),"件"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-time-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"進行中作業"}),e.jsxs("p",{className:"text-3xl font-bold",children:[i.reduce((t,a)=>t+a.inProgressTasks,0),"件"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-percent-line text-2xl"})})}),e.jsx("p",{className:"text-sm opacity-90 mb-1",children:"平均進捗率"}),e.jsxs("p",{className:"text-3xl font-bold",children:[i.length>0?Math.round(i.reduce((t,a)=>t+a.avgProgress,0)/i.length):0,"%"]})]})]}),P.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4",children:"カテゴリ別統計"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:P.map(t=>e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:`w-8 h-8 ${B(t.category)} rounded-lg`}),e.jsx("span",{className:"font-medium text-gray-900",children:t.label})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"作業数"}),e.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[t.count,"件"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"平均進捗率"}),e.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[t.avgProgress,"%"]})]})]})]},t.category))})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto",children:[e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"利用者別作業実績"})}),i.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx("i",{className:"ri-inbox-line text-4xl mb-2"}),e.jsx("p",{children:"データがありません"})]}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 bg-gray-50",children:[e.jsx("th",{className:"p-4 text-left text-sm font-bold text-gray-900",children:"利用者名"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"総作業数"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"完了作業"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"進行中作業"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"平均進捗率"}),e.jsx("th",{className:"p-4 text-center text-sm font-bold text-gray-900",children:"進捗記録数"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:i.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.username}),e.jsx("p",{className:"text-sm text-gray-500",children:t.furigana})]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium",children:[t.totalTasks,"件"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium",children:[t.completedTasks,"件"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium",children:[t.inProgressTasks,"件"]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-24 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-500 h-2 rounded-full",style:{width:`${t.avgProgress}%`}})}),e.jsxs("span",{className:"text-sm font-bold text-gray-900 min-w-[45px]",children:[t.avgProgress,"%"]})]})}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium",children:[t.totalRecords,"件"]})})]},t.userId))})]})]})]})]})]})}export{G as default};
//# sourceMappingURL=page-wUy9b5Y-.js.map
